{% load static %}
<div class="main-chat-container hide-chatbot d-flex align-items-center justify-content-center">
    <div class="container chat-container-wrapper hide-scrolllbar p-3 position-relative" style="border-radius: 30px;">
        <div class="chatbot-header pb-2">
            <div style="display: flex; align-items: center; gap: 12px;">
                <img src="{% static 'img/logo/logo-square.svg' %}" style="width: 40px;" alt="chatbot-logo">
                <span class="text-dark mb-0" style="font-weight: 800; font-size: 20px;">Lawa.ai</span>
            </div>
            <div class="d-flex align-items-center" style="gap: 5px;">
                <button class="clearBtn btn btn-secondary btn-md rounded-xl" >
                    <i class="fa fa-sm fa-redo mr-1"></i>
                    clear
                </button>
                <button class="closechatbot p-2 rounded-xl">
                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="#000000" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path fill-rule="evenodd" clip-rule="evenodd" d="M5.29289 5.29289C5.68342 4.90237 6.31658 4.90237 6.70711 5.29289L12 10.5858L17.2929 5.29289C17.6834 4.90237 18.3166 4.90237 18.7071 5.29289C19.0976 5.68342 19.0976 6.31658 18.7071 6.70711L13.4142 12L18.7071 17.2929C19.0976 17.6834 19.0976 18.3166 18.7071 18.7071C18.3166 19.0976 17.6834 19.0976 17.2929 18.7071L12 13.4142L6.70711 18.7071C6.31658 19.0976 5.68342 19.0976 5.29289 18.7071C4.90237 18.3166 4.90237 17.6834 5.29289 17.2929L10.5858 12L5.29289 6.70711C4.90237 6.31658 4.90237 5.68342 5.29289 5.29289Z" ></path> </g></svg>
                </button>
            </div>
        </div>
        <div class="chat-container w-100 mx-auto hide-scrolllbar" style="max-width: 800px; flex-grow: 1; padding: 20px 0px; display: flex; flex-direction: column; gap: 10px; background-color: white; text-wrap: pretty; overflow-y: auto; overflow-x: hidden;">
    
            <div class="start-block w-100 flex-grow-1 d-flex flex-column" >
                <div class="w-100 flex-grow-1 py-4 text-center">
                    <div>
                        <img src="{% static 'img/logo/logo-square.svg' %}"  alt="chatbot-logo">
                    </div>
                    <h6 class="text-center text-dark d-block mx-auto" style="max-width: 400px; margin-top: 10px; font-weight: 600; text-wrap:pretty;">
                        Start asking your questions and the agent will answer them.
                    </h6>
                </div>
                <div class="w-100" style="max-width: 800px;">
                    <!-- <h6 class="d-block mb-1 text-center text-dark" style="font-weight: 500;">Examples</h6> -->
                    <div class="row m-0 p-0" >
                        <div style="cursor: pointer;" class="col-12 col-sm-6 col-lg-4 p-1">
                            <small style="border-radius: 12px;" class="question-item h-100 border px-3 py-3 d-flex align-items-center">List out the tours to United Arab Emirates</small>
                        </div>
                        <!-- <div style="cursor: pointer;" class="col-12 col-sm-6 col-lg-4 p-1">
                            <small style="border-radius: 12px;" class="question-item h-100 border px-3 py-3 d-flex align-items-center">Which tour include visit to Taj Mahal</small>
                        </div>
                        <div style="cursor: pointer;" class="col-12 col-sm-6 col-lg-4 p-1">
                            <small style="border-radius: 12px;" class="question-item h-100 border px-3 py-3 d-flex align-items-center">How much is the cost of a tour to France</small>
                        </div> -->
                        <div style="cursor: pointer;" class="col-12 col-sm-6 col-lg-4 p-1">
                            <small style="border-radius: 12px;" class="question-item h-100 border px-3 py-3 d-flex align-items-center">Tell me popular places to visit in Osaka</small>
                        </div>
                        <!-- <div style="cursor: pointer;" class="col-12 col-sm-6 col-lg-4 p-1">
                            <small style="border-radius: 12px;" class="question-item h-100 border px-3 py-3 d-flex align-items-center">How can I apply for Dubai visa</small>
                        </div> -->
                        <div style="cursor: pointer;" class="col-12 col-sm-6 col-lg-4 p-1">
                            <small style="border-radius: 12px;" class="question-item h-100 border px-3 py-3 d-flex align-items-center">Which documents are required to apply for US visa</small>
                        </div>
                    </div>
                </div>

            </div>

            
        </div>
        <div class="input-options-container border rounded-pill shadow-sm mx-auto" style="max-width: 800px; width: 100%; display: flex; justify-content: space-between; align-items: center; gap: 5px; padding: 8px; border-top: 1px solid rgb(218, 218, 218);">
            <div class="hide-scrolllbar" style="flex-grow: 1; display: flex; align-items: center; gap: 16px; overflow-y: scroll; overflow: visible;">
                <button id="micStartButton" style="width: 40px; height: 40px; padding: 10px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 30px; border: none; color: white; outline: none;">
                    <svg width="18px" height="18px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512"><path d="M176 352c53 0 96-43 96-96V96c0-53-43-96-96-96S80 43 80 96v160c0 53 43 96 96 96zm160-160h-16c-8.8 0-16 7.2-16 16v48c0 74.8-64.5 134.8-140.8 127.4C96.7 376.9 48 317.1 48 250.3V208c0-8.8-7.2-16-16-16H16c-8.8 0-16 7.2-16 16v40.2c0 89.6 64 169.6 152 181.7V464H96c-8.8 0-16 7.2-16 16v16c0 8.8 7.2 16 16 16h160c8.8 0 16-7.2 16-16v-16c0-8.8-7.2-16-16-16h-56v-33.8C285.7 418.5 352 344.9 352 256v-48c0-8.8-7.2-16-16-16z"/></svg>
                </button>
                <div id="question-box" class="d-inline-block" role="textbox" contenteditable="true" data-placeholder="Write your question here... " style="width: 100%; max-height: 100px; outline: none; font-weight: 500; font-size: 14px;">
                </div>
            </div>
            <button class="sendbtn" style="width: 40px; height: 40px; padding: 8px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 30px; border: none; color: white;">
                <svg style="rotate: 315deg;" width="20px" height="20px" viewBox="0 0 24 24" fill="none" stroke="#ffffff"  xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M11.5003 12H5.41872M5.24634 12.7972L4.24158 15.7986C3.69128 17.4424 3.41613 18.2643 3.61359 18.7704C3.78506 19.21 4.15335 19.5432 4.6078 19.6701C5.13111 19.8161 5.92151 19.4604 7.50231 18.7491L17.6367 14.1886C19.1797 13.4942 19.9512 13.1471 20.1896 12.6648C20.3968 12.2458 20.3968 11.7541 20.1896 11.3351C19.9512 10.8529 19.1797 10.5057 17.6367 9.81135L7.48483 5.24303C5.90879 4.53382 5.12078 4.17921 4.59799 4.32468C4.14397 4.45101 3.77572 4.78336 3.60365 5.22209C3.40551 5.72728 3.67772 6.54741 4.22215 8.18767L5.24829 11.2793C5.34179 11.561 5.38855 11.7019 5.407 11.8459C5.42338 11.9738 5.42321 12.1032 5.40651 12.231C5.38768 12.375 5.34057 12.5157 5.24634 12.7972Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
            </button>
        </div>
    </div>
</div>

<button class="startchatbtn pulse btn btn-warning border-0 rounded-circle d-flex align-items-center justify-content-center p-3" style="width: 50px; height:50px; position: fixed; bottom: 30px; right: 30px; z-index: 10; cursor: pointer;" >
    <!-- <i class="fa fa-cubes fa-2x text-dark" ></i> -->
     <img src="{% static 'img/logo/logo-small.svg' %}" alt="chatbot-logo">
</button>



<!-- SocketIO -->
<script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>


<script>
    const startButton = document.getElementById('micStartButton');

    let recognition;
    let isRecording = false;
    let isSupported = true;
    let silenceTimer;
    const silenceThreshold = 1000; // 1.5 seconds of silence before stopping

    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onstart = function() {
            isRecording = true;
            startButton.classList.add("pulse");
            $("#question-box").attr("data-placeholder", "Listening...")
        };

        recognition.onresult = function(event) {
            let interimTranscript = '';
            let finalTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                    $("#question-box").text(finalTranscript);
                } else {
                    interimTranscript += event.results[i][0].transcript;
                    $("#question-box").text(interimTranscript);
                }
            }
            // Reset the silence timer whenever we get a result
            resetSilenceTimer();
        };

        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            if(!isSupported){
                alert("Sorry, Voice capture is not supported for your current system.")
            }else{
                alert(event.error);
            }
        };

        recognition.onend = function() {
            isRecording = false;
            startButton.classList.remove("pulse");
            $("question-box").html("");
        };

    } 
    else {
        isSupported = false;
    }

    startButton.addEventListener('click', function() {
        if(!isSupported){
            alert("Sorry, Voice capture is not supported for your current system.")
        } else {
            if (isRecording) {
                stopRecording();
                $("question-box").html("");
            } else {
                startRecording();
            }
        }
    });

    function startRecording() {
        recognition.start();
    }

    function stopRecording() {
        recognition.stop();
        clearTimeout(silenceTimer);
    }

    function resetSilenceTimer() {
        clearTimeout(silenceTimer);
        silenceTimer = setTimeout(() => {
            if (isRecording) {
                stopRecording();
                $(".sendbtn").click();
                $("question-box").html("");
            }
        }, silenceThreshold);
    }

</script>